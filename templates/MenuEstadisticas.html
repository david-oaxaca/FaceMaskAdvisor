{% extends 'layouts/Layout_Charts.html' %}

{% block body %}

    <script>

        $(document).ready(function(){
            let myChart = document.getElementById('myChart').getContext('2d');
            let myChart_donut = document.getElementById('myChart_donut').getContext('2d');

            let barChart;
            let donutChart;

            let Chart_option = 1;

            function getDay(){
                let curr = new Date();
                let hours = [];

                for (let i = 0; i <= 23; i++) {
                    let date = curr.getFullYear()+'-'+(curr.getMonth()+1)+'-'+curr.getDate();; 
                    let hour = i;
                    if (i < 10) {
                        hour   = "0"+hour;
                    }
                    hours.push(hour + ":00:00");
                }
                return hours;
            }

            function getWeek(){
                let curr = new Date; 
                let week = [];

                for (let i = 1; i <= 7; i++) {
                    let first = curr.getDate() - curr.getDay() + i; 
                    let day = new Date(curr.setDate(first)).toISOString().slice(0, 10);
                    week.push(day);
                }
                return week;
            }

            function getMonth(){
                let curr = new Date; 
                let DaysInMonth = new Date(curr.getFullYear(), curr.getMonth() + 1, 0).getDate();
                let month = [];

                for (let i = 1; i <= DaysInMonth; i++) {
                    let day = new Date(curr.setDate(i)).toISOString().slice(0, 10);
                    month.push(day);
                }
                return month;
            }

            function graphWeeklyResults(chart_type){
                var js_data = JSON.stringify(getWeek());
                $.ajax({                        
                    url: '/get-week-analyses',
                    type : 'post',
                    contentType: 'application/json',
                    dataType : 'json',
                    data : js_data
                }).done(function(result) {
                    console.log(result);
                    if(chart_type === 1){
                        graphBarChart(getWeek(), result);
                    }else if(chart_type === 2){
                        graphDonutChart([1, 1, 1]);
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.log("fail: ",textStatus, errorThrown);
                });
            }


            function graphBarChart(dates, analyses_count){

                barChart = new Chart(myChart, {
                    type: 'bar', //Types of charts: Bar, HorizontalBar, pie, line, donut, radar, polarArea
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Uso correcto del cubrebocas',
                            data: analyses_count[2],
                            backgroundColor: '#00796B',
                            hoverBorderWidth: '1',
                            hoverBackgroundColor: "#00E676"
                        },
                        {
                            label: 'Uso incorrecto del cubrebocas',
                            data:analyses_count[1],
                            backgroundColor: '#00BFA5',
                            hoverBorderWidth: '1',
                            hoverBackgroundColor: "#EF6C00"
                        },
                        {
                            label: 'No llevaba cubrebocas',
                            data:analyses_count[0],
                            backgroundColor: '#B2DFDB',
                            hoverBorderWidth: '1',
                            hoverBackgroundColor: "#C62828"
                        }]
                    },
                    options: {
                        plugins:{
                            title:{
                                display:true,
                                text:'Estadisticas semanales del uso correcto del cubrebocas',
                                font: {
                                    size: 25,
                                    weight: 'bold'
                                }

                            },
                            legend:{
                                position:'right',
                                labels:{
                                    fontColor:'#000000'
                                }
                            },
                            layout: {
                                padding: {
                                    left: 50,
                                    right: 0,
                                    bottom: 0,
                                    top: 0 
                                }
                            },
                            tooltips:{
                                enabled:true
                            }
                        }
                    }
                });
            }

            function graphDonutChart(total_count){
                donutChart = new Chart(myChart_donut, {
                    type: 'doughnut', //Types of charts: Bar, HorizontalBar, pie, line, donut, radar, polarArea
                    data: {
                        labels: ['Uso correcto del cubrebocas','Uso incorrecto del cubrebocas','No trae cubrebocas'],
                        datasets: [{
                            data:total_count,
                            backgroundColor: ['#00796B', '#00BFA5', '#B2DFDB'],
                            hoverBackgroundColor: ['#00E676', '#EF6C00', '#C62828']
                        }]
                    },
                    options: {
                        plugins:{
                            title:{
                                display:true,
                                text:'Estado del cubrebocas',
                                font: {
                                    size: 25,
                                    weight: 'bold'
                                }

                            },
                            legend:{
                                labels:{
                                    fontColor:'#000000'
                                }
                            },
                            layout: {
                                padding: {
                                    left: 50,
                                    right: 0,
                                    bottom: 0,
                                    top: 0 
                                }
                            },
                            tooltips:{
                                enabled:true
                            }
                        }
                    }
                });
            }
            

            $('#weekly-stats-btn').hide();
            $('#bar-chart-btn').hide();
            $('#myChart_donut').hide();
            graphWeeklyResults(1);
            graphWeeklyResults(2);
            

            $('#daily-stats-btn').click(function(){
                barChart.destroy();
                $('#daily-stats-btn').hide();
                $('#weekly-stats-btn').show();
                $('#monthly-stats-btn').show();
                graphBarChart(getDay(), [[],[],[]]);
            });

            $('#weekly-stats-btn').click(function(){
                barChart.destroy();
                $('#daily-stats-btn').show();
                $('#weekly-stats-btn').hide();
                $('#monthly-stats-btn').show();
                if(Chart_option === 1){
                    graphWeeklyResults(1);
                }else if(Chart_option === 2){
                    graphWeeklyResults(2);
                }
                
            });

            $('#monthly-stats-btn').click(function(){
                barChart.destroy();
                $('#daily-stats-btn').show();
                $('#weekly-stats-btn').show();
                $('#monthly-stats-btn').hide();
                graphBarChart(getMonth(), [[],[],[]]);
            });

            $('#bar-chart-btn').click(function(){
                $('#bar-chart-btn').hide();
                $('#donut-chart-btn').show();
                $('#myChart').show();
                $('#myChart_donut').hide();
                Chart_option = 1;
            });

            $('#donut-chart-btn').click(function(){
                $('#bar-chart-btn').show();
                $('#donut-chart-btn').hide();
                $('#myChart').hide();
                $('#myChart_donut').show();
                Chart_option = 2;
            });

        });
    </script>

    <div class="d-flex" id="content-wrapper">

        <!-- Sidebar -->
        <div id="sidebar-container" class="bg-primary">
            <div class="logo">
                <h4 class="text-light font-weight-bold mb-0"><a href="/inicio" class="d-block text-light p-3 border-0">Face Mask Advisor</a></h4>
            </div>
            <div class="menu">
              <p class="d-block text-light p-3 border-0"><i class="icon ion-md-finger-print lead mr-2"></i>
                {{g.user.nombre}} {{g.user.apellido_pat}}</p>
                <a href="/test" class="d-block text-light p-3 border-0"><i class="icon ion-md-pulse lead mr-2"></i>
                    Realizar prueba</a>
                <a href="/charts" class="d-block text-light p-3 border-0"><i class="icon ion-md-stats lead mr-2"></i>
                    Estad√≠sticas</a>
                <a href="/user_account" class="d-block text-light p-3 border-0"><i class="icon ion-md-person lead mr-2"></i>
                    Datos de la cuenta</a>
                <a href="/advices" class="d-block text-light p-3 border-0"> <i class="icon ion-md-paper lead mr-2"></i>
                    Avisos recientes</a>
                    <a href="/help" class="d-block text-light p-3 border-0"><i class="icon ion-md-information-circle lead mr-2"></i>
                      Ayuda</a>
                      <a href="/logout" class="d-block text-light p-3 border-0"><i class="icon ion-md-exit lead mr-2"></i>
                        Cerrar sesi√≥n</a>
            </div>
        </div>
        <!-- Fin sidebar -->

        <div class="w-100">

        <!-- Page Content -->
        <div id="content" class="bg-light w-100">

            <section class="bg-light py-3">
                
                <div>
                    <h1 class="font-weight-bold mb-0"><center>Estadisticas del uso del cubrebocas</center></h1>
                </div>
            
            </section> 
            
            <div class="row">
                <div style="width: 100%;">
                    <button type="button" id="daily-stats-btn"  class="button-statistics btn btn-primary"  style="width:200px">Estadisticas diarias</button>
                    <button type="button" id="weekly-stats-btn" class="button-statistics btn btn-primary"  style="width:200px;">Estadisticas semanales</button>
                    <button type="button" id="monthly-stats-btn" class="button-statistics btn btn-primary" style="width:200px">Estadisticas mensuales</button>
                    <button type="button" id="bar-chart-btn" class="button-statistics btn btn-primary"  style="width:200px;">Personas por fecha</button>
                    <button type="button" id="donut-chart-btn" class="button-statistics btn btn-primary" style="width:200px">Estado del cubrebocas</button>
                </div>
            </div>

            <div>
                <div>
                   
                    <div style="text-align: center;">
                        <div style="padding: 20px;">
                            <canvas id="myChart"></canvas>
                        </div>
    
                        <div style="height: 60%; width: 75%; margin-left: 10%; text-align: center;">
                            <canvas id="myChart_donut"></canvas>
                        </div>
                    </div>
                    
                </div>
                <div>
                    
            </div>
        </div>
    </div>
    

            
       
{% endblock %}